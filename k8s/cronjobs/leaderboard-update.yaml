# Leaderboard Update CronJob
# Runs every 5 minutes to compute and cache leaderboard rankings
#
# Prerequisites:
# - Go backend deployment must be running
# - ADMIN_SECRET must be set in the ConfigMap/Secret
# - NetworkPolicy must allow this job to reach the backend
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: leaderboard-update
  namespace: default
  labels:
    app: scribble
    component: leaderboard-cron
spec:
  # Run every 5 minutes
  schedule: "*/5 * * * *"

  # Timezone for schedule (optional, defaults to cluster timezone)
  # timeZone: "UTC"

  # Keep last 3 successful jobs for debugging
  successfulJobsHistoryLimit: 3

  # Keep last 1 failed job for debugging
  failedJobsHistoryLimit: 1

  # Don't start new job if previous is still running
  concurrencyPolicy: Forbid

  # Don't start missed jobs if scheduler was down
  startingDeadlineSeconds: 60

  jobTemplate:
    spec:
      # Auto-cleanup after 10 minutes
      ttlSecondsAfterFinished: 600

      # Retry up to 2 times on failure
      backoffLimit: 2

      template:
        metadata:
          labels:
            app: scribble
            component: leaderboard-cron
        spec:
          restartPolicy: OnFailure

          # Use a lightweight image with curl
          containers:
          - name: leaderboard-updater
            image: curlimages/curl:8.5.0

            # Call the compute endpoint with admin secret
            command:
            - /bin/sh
            - -c
            - |
              echo "Starting leaderboard computation at $(date -u +%Y-%m-%dT%H:%M:%SZ)"

              # Call the compute endpoint
              response=$(curl -s -w "\n%{http_code}" \
                -X POST \
                -H "X-Admin-Secret: ${ADMIN_SECRET}" \
                -H "Content-Type: application/json" \
                "${GO_BACKEND_URL}/internal/leaderboards/compute")

              # Extract HTTP status code (last line)
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | head -n -1)

              echo "Response: $body"
              echo "HTTP Status: $http_code"

              # Check for success (2xx status and success flag in response)
              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                # Verify response contains success:true
                if echo "$body" | grep -q '"success":true'; then
                  echo "Leaderboard computation completed successfully"
                  exit 0
                else
                  echo "Response missing success flag, body: $body"
                  exit 1
                fi
              else
                echo "Leaderboard computation failed with status $http_code"
                exit 1
              fi

            env:
            - name: GO_BACKEND_URL
              value: "http://scribble-go-backend:8080"
            - name: ADMIN_SECRET
              valueFrom:
                secretKeyRef:
                  name: scribble-secrets
                  key: admin-secret

            resources:
              requests:
                cpu: "10m"
                memory: "16Mi"
              limits:
                cpu: "50m"
                memory: "32Mi"

            # Security context
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              runAsNonRoot: true
              runAsUser: 1000
              capabilities:
                drop:
                  - ALL
# Note: scribble-secrets Secret must be created separately
# See k8s/secrets/scribble-secrets.yaml.example for template
